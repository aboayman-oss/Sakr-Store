<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Product Details - Sakr Store</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <header>
      <button id="menu-toggle" class="hamburger-menu" aria-label="Toggle menu" aria-controls="category-sidebar" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1>Sakr Store</h1>
      <nav>
        <button id="theme-toggle-btn" aria-label="Toggle dark mode">
          <i class="ri-sun-line" id="light-icon"></i>
          <i class="ri-moon-line" id="dark-icon"></i>
        </button>
        <a href="cart.html" class="cart-link" aria-label="View shopping cart">
          <i class="ri-shopping-cart-2-line"></i>
          <span class="cart-count" aria-label="Items in cart">0</span>
        </a>
      </nav>
    </header>
    <div id="menu-overlay" class="menu-overlay"></div>
    
    <main class="product-detail-page">
      <div class="product-container">
        <div class="product-media-column">
          <div class="product-image">
            <img src="" alt="" id="product-image">
          </div>
          <div class="product-thumbnails" id="product-thumbnails" aria-label="More product images"></div>
        </div>
        <div class="product-info">
          <h1 id="product-title"></h1>
          <p class="product-price" id="product-price"></p>
          <p class="product-description" id="product-description"></p>
          <div class="product-actions">
            <div class="quantity-selector">
              <button class="quantity-btn" id="decrease-quantity" aria-label="Decrease quantity">-</button>
              <input type="number" id="quantity" value="1" min="1" aria-label="Product quantity">
              <button class="quantity-btn" id="increase-quantity" aria-label="Increase quantity">+</button>
            </div>
            <button class="add-to-cart-btn" id="add-to-cart">
              <i class="ri-shopping-cart-2-line"></i>
              Add to Cart
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Toast notification container -->
    <div id="toast-container" class="toast-container" aria-live="polite"></div>

    <!-- Lightbox overlay for product images -->
    <div id="lightbox" class="lightbox" aria-hidden="true" role="dialog" aria-label="Product image gallery">
      <button class="lightbox-close" aria-label="Close gallery">&times;</button>
      <button class="lightbox-nav prev" aria-label="Previous image">&#10094;</button>
      <img id="lightbox-image" alt="Product image enlarged">
      <button class="lightbox-nav next" aria-label="Next image">&#10095;</button>
    </div>
    
    <script src="js/app.js"></script>
    <script>
      // Product page specific JavaScript
      document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = parseInt(urlParams.get('id'));
        
        // Quantity controls
        const quantityInput = document.getElementById('quantity');
        const decreaseBtn = document.getElementById('decrease-quantity');
        const increaseBtn = document.getElementById('increase-quantity');
        
        decreaseBtn.addEventListener('click', () => {
          const currentValue = parseInt(quantityInput.value);
          if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
          }
        });
        
        increaseBtn.addEventListener('click', () => {
          const currentValue = parseInt(quantityInput.value);
          quantityInput.value = currentValue + 1;
        });

        // Load and display product details
        let currentImageIndex = 0; // track current main image index for lightbox
        let currentImages = [];    // track all images for this product

        fetch('products.json')
          .then(response => response.json())
          .then(products => {
            const product = products.find(p => p.id === productId);
            if (product) {
              // Resolve images: primary + gallery (new schema) with fallback to legacy `image`
              const primary = (product.images && product.images.primary) ? product.images.primary : (product.image || '');
              const gallery = (product.images && Array.isArray(product.images.gallery)) ? product.images.gallery : [];
              const allImages = [primary, ...gallery].filter(Boolean);
              currentImages = allImages;

              const mainImgEl = document.getElementById('product-image');
              mainImgEl.src = allImages[0] || '';
              mainImgEl.alt = product.name || 'Product image';
              currentImageIndex = 0;

              // Clicking the main image opens the lightbox at the current index
              mainImgEl.style.cursor = allImages.length > 0 ? 'zoom-in' : 'default';
              mainImgEl.addEventListener('click', () => {
                if (currentImages.length > 0) openLightbox(currentImageIndex);
              });

              document.getElementById('product-title').textContent = product.name;
              if (product.discount) {
                document.getElementById('product-price').innerHTML = `<span class='product-original-price'>EGP ${product.price.toFixed(2)}</span> <span class='product-discounted-price'>EGP ${product.discountedPrice.toFixed(2)}</span>`;
              } else {
                document.getElementById('product-price').textContent = `EGP ${product.price.toFixed(2)}`;
              }
              document.getElementById('product-description').textContent = product.description || '';

              // Build thumbnails if more than one image
              const thumbsContainer = document.getElementById('product-thumbnails');
              if (thumbsContainer) {
                thumbsContainer.innerHTML = '';
                if (allImages.length > 1) {
                  allImages.forEach((src, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'thumbnail-btn' + (idx === 0 ? ' active' : '');
                    btn.type = 'button';
                    btn.setAttribute('aria-label', 'View image ' + (idx + 1));
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = product.name ? `${product.name} - image ${idx + 1}` : `Image ${idx + 1}`;
                    btn.appendChild(img);
                    btn.addEventListener('click', () => {
                      mainImgEl.src = src;
                      currentImageIndex = idx;
                      thumbsContainer.querySelectorAll('.thumbnail-btn').forEach(el => el.classList.remove('active'));
                      btn.classList.add('active');
                    });
                    thumbsContainer.appendChild(btn);
                  });
                } else {
                  // Hide the thumbnails container if only one image
                  thumbsContainer.style.display = 'none';
                }
              }
            } else {
              window.location.href = 'index.html'; // Redirect if product not found
            }
          })
          .catch(error => {
            console.error('Error loading product:', error);
            window.location.href = 'index.html';
          });

        // Add to cart functionality
        const addToCartBtn = document.getElementById('add-to-cart');
        addToCartBtn.addEventListener('click', () => {
          const quantity = parseInt(quantityInput.value);
          for (let i = 0; i < quantity; i++) {
            addToCart(productId); // Use the app.js addToCart function
          }
          
          // Visual feedback
          addToCartBtn.classList.add('added');
          setTimeout(() => addToCartBtn.classList.remove('added'), 1000);
        });
        // Lightbox logic
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-image');
        const btnPrev = document.querySelector('.lightbox-nav.prev');
        const btnNext = document.querySelector('.lightbox-nav.next');
        const btnClose = document.querySelector('.lightbox-close');

        function setLightboxImage(index) {
          if (!currentImages.length) return;
          currentImageIndex = (index + currentImages.length) % currentImages.length;
          lightboxImg.src = currentImages[currentImageIndex];
        }

        function openLightbox(index = 0) {
          if (!currentImages.length) return;
          setLightboxImage(index);
          lightbox.classList.add('open');
          lightbox.setAttribute('aria-hidden', 'false');
          document.body.classList.add('lb-open');
        }

        function closeLightbox() {
          lightbox.classList.remove('open');
          lightbox.setAttribute('aria-hidden', 'true');
          document.body.classList.remove('lb-open');
        }

        btnPrev.addEventListener('click', () => setLightboxImage(currentImageIndex - 1));
        btnNext.addEventListener('click', () => setLightboxImage(currentImageIndex + 1));
        btnClose.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox) closeLightbox(); // click on backdrop closes
        });

        document.addEventListener('keydown', (e) => {
          if (!lightbox.classList.contains('open')) return;
          if (e.key === 'Escape') closeLightbox();
          if (e.key === 'ArrowLeft') setLightboxImage(currentImageIndex - 1);
          if (e.key === 'ArrowRight') setLightboxImage(currentImageIndex + 1);
        });
      });
    </script>
  </body>
</html>